apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: vault
  namespace: flux-system
spec:
  interval: 5m
  targetNamespace: vault
  install:
    createNamespace: true
  chart:
    spec:
      chart: vault
      sourceRef:
        kind: HelmRepository
        name: hashicorp
        namespace: flux-system
      version: "0.31.0"
  values:
    injector:
      enabled: false

    csi:
      enabled: true
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          cpu: 50m
          memory: 128Mi

    ui:
      enabled: true
      serviceType: ClusterIP

    server:
      extraSecretEnvironmentVars:
        - envName: VAULT_PG_CONNECTION_URL
          secretName: vault-postgres-creds
          secretKey: connection_url

      image:
        repository: "hashicorp/vault"
        tag: "1.21.0-rc1"
        pullPolicy: IfNotPresent

      logLevel: "info"
      logFormat: "json"

      ingress:
        enabled: true
        ingressClassName: nginx
        hosts:
          - host: vault.local
            paths:
              - /

      resources:
        requests:
          memory: 256Mi
          cpu: 250m
        limits:
          memory: 256Mi
          cpu: 250m

      dataStorage:
        enabled: false

      dev:
        enabled: false

      standalone:
        enabled: false

      ha:
        enabled: true
        replicas: 1

        config: |
          ui = true

          listener "tcp" {
            tls_disable = 1
            address = "[::]:8200"
            cluster_address = "[::]:8201"
          }

          storage "postgresql" {
            connection_url = "env://VAULT_PG_CONNECTION_URL"
            ha_enabled = true
          }

          service_registration "kubernetes" {}
